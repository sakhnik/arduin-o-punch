# Користування Arduin-O-Punch

<a href="https://www.facebook.com/ZELESTAclub"><img alt="Зелеста" src="zelesta.jpg" width="512"/></a>

[Facebook: ZELESTAclub](https://www.facebook.com/ZELESTAclub)

Система відмітки [Arduin-O-Punch](https://github.com/sakhnik/arduin-o-punch)
складається із таких частин:

* мобільний додаток на телефоні з андроїдом
* станції розміром 124 х 72 х 32 мм
* програматор для конфігурації станцій
* картки для відмітки.

Учасники проходять дистанцію із картками і ставлять відмітки на кожному
контрольному пункті, прикладаючи картку до станції.
Мобільний додаток дозволяє підготувати картки учасників на передстартовій
реєстрації та зчитати і надіслати результати після фінішу для обробки у програму
[QuickEvent](https://github.com/Quick-Event/quickbox).
Програматор потрібен для підготовки станцій до змагань: задання ключа шифрування
відмітки, синхронізації годинників, підготовки внутрішньої пам’яті станцій до
запису відміток, перевірки параметрів тощо.

Система змодельована за принципом SPORTIndent, проте є й суттєві відмінності.
Наприклад, не потрібна окрема станція для очищення відміток перед стартом.

## Технічні характеристики системи

| Параметр    |   Значення   |
|-------------|--------------|
| Робоча напруга схеми  |   3.3 В |
| Час роботи станції від повністю зарядженого акумулятора 3000 мА·г | ~7 днів |
| Роздільна здатність годинника  |  1 сек  |
| Точність годинника    |   3.5 ppm ~ 0.3 сек/день |
| Максимальна кількість відміток на картці | 176 |
| Максимальна кількість записів у станції  | 8000 (до 1 підходу)<br/>4000 (до 3 підходів)<br/>2000 (до 15 підходів) |
| Температурний діапазон |   0–40 °C |

## Учасникам

Під час реєстрації видається стартовий номер, який буде використаний у картці
відмітки для ідентифікації. Організатори підготують і видадуть готову до
проходження дистанції картку під час мандатної комісії.

Для успішного проходження дистанції потрібно відмітитися на старті, потім на
всіх контрольних пунктах дистанції у заданому порядку (або й ні залежно від умов
змагань), нарешті на фініші.

Відмітка записується у картку шляхом піднесення до коробки станції до отримання
звукового і видимого підтвердження. Коротний і довгий сигнал «ті-таа», як у
літері А в азбуці Морзе. Якщо одночасно піднесуть свої картки кілька учасників,
станція поставить відмітку усім, оскільки це відбувається швидко. При цьому
звуковий сигнал свідчитиме про кількість відмічених карток. Наприклад,
«ті-ті-таа» для двох карток, «ті-ті-ті-таа» для трьох карток і так далі.
Якщо з якоїсь причини місця на картці для відмітки більше немає, станція
повідомить «ті-ті-таа-ті», як літера F в азбуці Морзе.

Результат зчитують після фінішу секретарі змагань з допомогою мобільного додатку
Android. Він автоматично вивантажується у програму QuickEvent для обробки і
відразу видається друкована квитанція. Відмітка продовжує зберігатися на картці
до наступного старту.

Окремої станції для очищення немає і це не потрібно, оскільки попередні відмітки
очищуються на стартовому контрольному пункті.

## Організаторам

### Підготовка станцій до змагань

* Вибрати таємний ключ шифрування 12 шістнадцяткових цифр (0–9, A–F).
* Підготувати тестову картку з допомогою мобільного застосунку Android

Для кожної станцій виконати такі дії:

* Зарядити акумулятори станцій або переконатися з допомогою індикатора, що вони заряджені
* Під’єднати програматор, перевірити і виправити налаштування:
  - Номер станції має відповідати маркуванню
  - Задати і перевірити ключ шифрування
  - Підготувати записувач відмітки для очікуваної кількості учасників
  - Синхронізувати годинник
* Перевірити правильність відмітки на тестовій картці
* Роз’єднати акумулятор для вимкнення і заощадження заряду

### Розміщення станцій у контрольних пунктах

* Під’єднати акумулятор
* Закрити корпус, прикріпити станцію на рейку
* Перевірити правильність відмітки на тестовій картці

### Підготовка карток перед стартом

* Визначити номер учасника в програмі QuickEvent
* Відкрити розділ «Підготувати картку бігуна» в застосунку Android
* Задати номер учасника в текстовому полі або відсканувати QR-код реєстрації
    учасника з QuickEvent
* Прикласти чисту картку до телефону і пересвідчитися, що прогрес дійшов до
    кінця і закінчився успішно
* Позначити кратку наліпкою із підписаним номером для зручності учасника.

Для зменшення черги учасників можуть обслуговувати кілька секретарів одночасно.

### Після збору станцій

* При потребі під’єднати програматор, щоб отримати список відмічених карток або
    щоб перевірити підхід певного учасника
* Від’єднати акумулятор для заощадження заряду

### Відновлення карток після змагань

* Відкрити розділ «Скинути картку бігуна» в застосунку Android
* Піднести по черзі кожну картку, щоб скинути записаний ключ шифрування у
    початковий стан

Карток може бути багато, тому для краще це виконувати кількома телефонами
одночасно.

## Підготовка і конфігурування

### Акумулятор

Для заряджання акумулятора потрібно під’єднати зарядний пристрій до гнізда micro
USB.

Рівень заряду акумулятора можна перевірити, натиснувши на кнопку увімкнення
індикатора. Або поміряти напругу на клемах акумулятора. Вона повинна бути в
діапазоні 3,0–4,2 В. Наполовину заряджений акумулятор має напругу десь 3,7 В.

### Програматор

### CLI

### Ключ шифрування

### Годинник

Щоб мати надійні достовірні результати потрібно щоб всі станції працювали
синхронно, тобто щоб годинники у станціях показували однаковий час. Взагалі-то,
це не є геть обов’язковою умовою. Наприклад, якщо всі учасники отримують
стартову і фінішну відмітку на одних і тих самих станціях, лідери так само
залишаться лідерами в підсумку. Навіть незважаючи на, можливо, неправильні
значення темпу. Проте якщо всі станції показують однаковий час, тоді можна
отримати правильний розрахунок темпу при відвідуванні кожного контрольного
пункту.

Станції послуговуються точним годинником справжнього часу з резервним елементом
живлення CR2032, заряду якого має вистачити на кілька років.

Для синхронізації годинника потрібно під’єднати програматор і запустити на
комп’ютері скрипт `sync-сlock.py`.

TBD

### Журнал відмітки

Записування відмічених карток у станції може знадобитися для додаткового
підтвердження відмітки. Для активування цієї функції потрібно оцінити очікувану
кількість учасників (максимальний стартовий номер) і кількість заходів одного
учасника на цей конкретний контрольний пункт. Наприклад, у центральній точці
«метелика» очікується кілька відвідувань.

```
recfmt <найбільший номер> [1|2|4|8]
```

|   Кількість бітів    |   Кількість заходів    |   Максимальний стартовий номер |
|----------------------|------------------------|--------------------------------|
|   1   | 0–1   |  8000  |
|   2   | 0–3   |  4000  |
|   4   | 0–15  |  2000  |
|   8   | 0–255 |  1000  |

Кількість бітів потрібно вибирати ощадливо, тому що кількість циклів записування
у внутрішню пам’ять обмежена приблизно 10000 разів.

TODO: Перевірка відмітки після зняття дистанції.
